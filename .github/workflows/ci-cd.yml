name: CI-CD pipeline

on:
  push:
    branches:
      - main

env:
  AWS_REGION: us-west-2
  AWS_ACCOUNT_ID: 630019796862

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMAGE_TAG: ${{ github.sha }}
    outputs:
      changed: ${{ steps.changes.outputs.changed }}

    steps:
      - name: Checkout app source
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Log in to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v1

      - name: Detect changed services
        id: changes
        run: |
          SERVICES=("ui" "catalog" "cart" "orders" "checkout")
          CHANGED=""
          if [ "$(git rev-list --count HEAD)" -eq 1 ]; then
            CHANGED="${SERVICES[*]}"
          else
            for s in "${SERVICES[@]}"; do
              if git diff --name-only HEAD^ HEAD | grep -q "^src/$s/"; then
                CHANGED="$CHANGED $s"
              fi
            done
          fi
          echo "Changed services: $CHANGED"
          echo "changed=$CHANGED" >> "$GITHUB_OUTPUT"

      - name: Build and push images for changed services
        if: steps.changes.outputs.changed != ''
        run: |
          for service in ${{ steps.changes.outputs.changed }}; do
            IMAGE_URI=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/retail-store-$service
            echo "Building and pushing $IMAGE_URI:${IMAGE_TAG}"
            docker build -t "$IMAGE_URI:$IMAGE_TAG" "./src/$service"
            docker push "$IMAGE_URI:$IMAGE_TAG"
          done

      - name: No services changed
        if: steps.changes.outputs.changed == ''
        run: echo "No src/* services changed; skipping image build and push."

  update-gitops:
    needs: build-and-push
    if: needs.build-and-push.outputs.changed != ''
    runs-on: ubuntu-latest

    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v3
        with:
          repository: GuyArnan/retail-app-argoCD-config
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          ref: main
          persist-credentials: false
          fetch-depth: 0

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Update image tags in GitOps values
        run: |
          TAG=${{ github.sha }}
          SERVICES=("ui" "catalog" "cart" "orders" "checkout")
          for service in "${SERVICES[@]}"; do
            VALUES_FILE="charts/$service/values.yaml"
            if [ -f "$VALUES_FILE" ]; then
              echo "Updating $VALUES_FILE image.tag -> $TAG"
              yq -i '.image.tag = "'"$TAG"'"' "$VALUES_FILE"
            fi
          done

      - name: Commit and push changes
        env:
          PAT: ${{ secrets.GITOPS_REPO_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git remote set-url origin https://x-access-token:${PAT}@github.com/GuyArnan/retail-app-argoCD-config.git

          git status
          if git diff --quiet; then
            echo "No changes to commit in GitOps repo."
            exit 0
          fi

          git commit -am "Update image tags to ${{ github.sha }}"
          git push
